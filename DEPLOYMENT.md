# Deployment Guide

This guide explains how to deploy your Hospitality PMS SaaS application to Vercel (frontend) and Render (backend).

## Architecture Overview

- **Frontend**: React + Vite app deployed to Vercel
- **Backend**: Express + Node.js API deployed to Render
- **Database**: PostgreSQL hosted on Render
- **Authentication**: Replit Auth (or custom auth)
- **Payments**: Stripe integration
- **AI Features**: OpenAI integration (optional)

## Prerequisites

1. [Vercel Account](https://vercel.com) - For frontend hosting
2. [Render Account](https://render.com) - For backend and database hosting
3. [Stripe Account](https://stripe.com) - For payment processing
4. [OpenAI API Key](https://platform.openai.com) - Optional, for AI features

## Part 1: Deploy Backend to Render

### Step 1: Create a Render Account

1. Sign up at [render.com](https://render.com)
2. Connect your GitHub repository

### Step 2: Deploy Using render.yaml

1. Push your code to GitHub
2. In Render dashboard, click "New +" → "Blueprint"
3. Connect your repository
4. Render will automatically detect `render.yaml` and create:
   - A PostgreSQL database
   - A web service for the backend

### Step 3: Configure Environment Variables

After deployment, add these environment variables in Render dashboard:

#### Required Variables (MUST be set before first deployment):
- `FRONTEND_URL` - **CRITICAL**: Your Vercel frontend URL (e.g., https://your-app.vercel.app) - Required for CORS to work
- `STRIPE_SECRET_KEY` - Your Stripe secret key (sk_live_...)
- `STRIPE_PRICE_ID_MONTHLY` - Your monthly subscription price ID
- `STRIPE_PRICE_ID_YEARLY` - Your yearly subscription price ID

#### Optional Variables:
- `OPENAI_API_KEY` - Your OpenAI API key (for AI features)
- `REPLIT_DB_URL` - If using Replit Auth

The following are auto-generated by Render:
- `DATABASE_URL` - Automatically provided by Render
- `SESSION_SECRET` - Auto-generated secure secret

### Step 4: Note Your Backend URL

After deployment, Render will provide a URL like:
```
https://hospitality-pms-backend.onrender.com
```

Save this URL - you'll need it for the frontend deployment.

## Part 2: Deploy Frontend to Vercel

### Step 1: Create a Vercel Account

1. Sign up at [vercel.com](https://vercel.com)
2. Install the Vercel CLI (optional):
   ```bash
   npm install -g vercel
   ```

### Step 2: Deploy to Vercel

#### Option A: Using Vercel Dashboard

1. Go to Vercel dashboard
2. Click "Add New Project"
3. Import your GitHub repository
4. Vercel will automatically detect the configuration from `vercel.json`

#### Option B: Using Vercel CLI

```bash
# Login to Vercel
vercel login

# Deploy
vercel --prod
```

### Step 3: Configure Environment Variables in Vercel

In the Vercel dashboard, go to your project → Settings → Environment Variables:

#### Required Variables:
- `VITE_API_URL` - Your Render backend URL (e.g., https://hospitality-pms-backend.onrender.com)
- `VITE_STRIPE_PUBLIC_KEY` - Your Stripe publishable key (pk_live_...)

### Step 4: Redeploy

After adding environment variables, trigger a redeploy in Vercel.

## Part 3: Update Backend with Frontend URL

1. Go back to Render dashboard
2. Update the `FRONTEND_URL` environment variable with your Vercel URL
3. Your backend will automatically redeploy

## Part 4: Configure Stripe Webhooks (Optional)

If you're using Stripe webhooks:

1. Go to Stripe Dashboard → Developers → Webhooks
2. Add endpoint: `https://your-backend.onrender.com/api/webhooks/stripe`
3. Select events you want to listen to
4. Copy the webhook signing secret
5. Add it to Render environment variables as `STRIPE_WEBHOOK_SECRET`

## Part 5: Database Migrations

The database will be automatically created by Render. To run migrations:

```bash
# Install dependencies locally
npm install

# Set your DATABASE_URL from Render
export DATABASE_URL="your_database_url_from_render"

# Run migrations
npm run db:push
```

## Environment Variables Summary

### Backend (Render)
```env
NODE_ENV=production
PORT=5000
DATABASE_URL=<auto-generated>
SESSION_SECRET=<auto-generated>
FRONTEND_URL=https://your-frontend.vercel.app
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PRICE_ID_MONTHLY=price_...
STRIPE_PRICE_ID_YEARLY=price_...
OPENAI_API_KEY=sk-... (optional)
```

### Frontend (Vercel)
```env
VITE_API_URL=https://your-backend.onrender.com
VITE_STRIPE_PUBLIC_KEY=pk_live_...
```

## Testing Your Deployment

1. Visit your Vercel URL (e.g., https://your-app.vercel.app)
2. Test the login functionality
3. Check that the dashboard loads
4. Verify API calls are working (check browser console for errors)
5. Test a subscription flow (use Stripe test mode first)

## Troubleshooting

### CORS Errors
- Ensure `FRONTEND_URL` in Render matches your Vercel URL exactly
- Check that both URLs use HTTPS in production

### Database Connection Issues
- Verify `DATABASE_URL` is set in Render
- Check Render logs for connection errors
- Ensure database is in the same region as your backend service

### Stripe Not Working
- Verify both `STRIPE_SECRET_KEY` (backend) and `VITE_STRIPE_PUBLIC_KEY` (frontend) are set
- Ensure you're using matching keys (both test or both live)
- Check Stripe dashboard for any errors

### OpenAI Features Not Working
- Add `OPENAI_API_KEY` to Render environment variables
- The app will show a friendly message if OpenAI is not configured

## Production Checklist

- [ ] Backend deployed to Render
- [ ] Database created and connected
- [ ] Frontend deployed to Vercel
- [ ] All environment variables configured
- [ ] Stripe keys added (both test and live)
- [ ] CORS configured correctly
- [ ] Health check endpoint responding
- [ ] Test user registration/login
- [ ] Test subscription flow
- [ ] OpenAI features tested (if using)
- [ ] Custom domain configured (optional)
- [ ] SSL certificates verified
- [ ] Error monitoring set up (optional: Sentry, LogRocket)

## Custom Domains (Optional)

### Vercel Custom Domain
1. Go to Project Settings → Domains
2. Add your custom domain
3. Update DNS records as instructed

### Render Custom Domain
1. Go to Service Settings → Custom Domain
2. Add your custom domain
3. Update DNS records as instructed

## Monitoring and Logs

### Render Logs
- View logs in Render dashboard → Your Service → Logs
- Set up log retention and alerts

### Vercel Logs
- View function logs in Vercel dashboard → Your Project → Deployments → Logs

## Cost Estimation

### Render Free Tier
- 750 hours/month of free runtime
- Free PostgreSQL database (90 days, then $7/month)
- Services spin down after 15 minutes of inactivity

### Render Paid Plans
- Starter: $7/month per service
- Database: $7/month (starter plan)

### Vercel
- Hobby: Free for personal projects
- Pro: $20/month per member (for commercial use)

## Support

For issues:
1. Check Render logs
2. Check Vercel deployment logs
3. Check browser console for frontend errors
4. Verify all environment variables are set correctly

## License Key System

This application uses a license key system for subscription management:

1. Users register and receive a 3-month free trial automatically
2. Trial includes all features (AI forecasting, dynamic pricing, etc.)
3. After trial, users must subscribe to maintain access
4. Subscriptions are managed through Stripe
5. License validation happens on every AI feature request

The license system is already built into the application - no additional configuration needed!
